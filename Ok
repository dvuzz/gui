-- === [ PHẦN CHUẨN BỊ ] ===
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer

-- === [ DỮ LIỆU GAP ] ===
local GapPositions = {
	Vector3.new(200, -3, 0),
	Vector3.new(286, -3, -1),
	Vector3.new(393, -3, 5),
	Vector3.new(541, -3, 5),
	Vector3.new(758, -3, 1),
	Vector3.new(1079, -3, 6),
	Vector3.new(1564, -3, -2),
	Vector3.new(2247, -3, -14),
	Vector3.new(2615, -3, 12)
}
local TotalGaps = #GapPositions

-- === [ BIẾN TOÀN CỤC ] ===
local SelectedPlayers = {}
local CurrentGap = 1
local BringDistance = 5
local LoopBringEnabled = false
local AutoGapEnabled = false
local TweenRunning = false
local CurrentTween = nil
local TweenSpeed = 100
local LandingCFrame = nil

-- === [ HÀM HỖ TRỢ ] ===
local function SafeGetCharacter()
	local char = LocalPlayer.Character
	if not char then return nil, nil, nil end
	local hum = char:FindFirstChildOfClass("Humanoid")
	local hrp = char:FindFirstChild("HumanoidRootPart")
	return char, hum, hrp
end

local function TweenToPosition(targetPosition, duration)
	local _, _, hrp = SafeGetCharacter()
	if not hrp then return end
	duration = duration or 1
	local tweenInfo = TweenInfo.new(duration, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut)
	local targetCFrame = CFrame.new(targetPosition)
	local tween = TweenService:Create(hrp, tweenInfo, {CFrame = targetCFrame})
	tween:Play()	return tween
end

local function GetPlayerList()
	local list = {}
	for _, player in pairs(Players:GetPlayers()) do
		if player ~= LocalPlayer then
			table.insert(list, player.Name)
		end
	end
	return list
end

local function BringPlayer(playerName)
	local targetPlayer = Players:FindFirstChild(playerName)
	if not targetPlayer then return end
	local targetChar = targetPlayer.Character
	if not targetChar then return end
	local targetHrp = targetChar:FindFirstChild("HumanoidRootPart")
	if not targetHrp then return end

	local _, _, hrp = SafeGetCharacter()
	if not hrp then return end

	local offset = hrp.CFrame.LookVector * BringDistance
	targetHrp.CFrame = hrp.CFrame + offset
end

local function BringSelectedPlayers()
	for _, name in ipairs(SelectedPlayers) do
		BringPlayer(name)
	end
end

local function StopCurrentTween()
	TweenRunning = false
	if CurrentTween then
		CurrentTween:Cancel()
		CurrentTween = nil
	end
end

local function TweenToGapWithLanding(gapNumber, callback)
	local _, _, hrp = SafeGetCharacter()
	if not hrp or gapNumber < 1 or gapNumber > TotalGaps then return end

	local targetPos = GapPositions[gapNumber]
	if not targetPos then return end

	StopCurrentTween()	TweenRunning = true

	local distance = (hrp.Position - targetPos).Magnitude
	local speed = math.max(TweenSpeed, 1)
	local duration = math.clamp(distance / speed, 0.5, 10)

	local tweenInfo = TweenInfo.new(duration, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut)
	CurrentTween = TweenService:Create(hrp, tweenInfo, {CFrame = CFrame.new(targetPos)})
	CurrentTween.Completed:Connect(function()
		TweenRunning = false
		CurrentTween = nil
		LandingCFrame = hrp.CFrame
		if callback then callback() end
	end)
	CurrentTween:Play()
end

-- === [ KHỞI TẠO GUI ] ===
local library = loadstring(game:HttpGet("https://raw.githubusercontent.com/dvuzz/gui/refs/heads/main/main.lua", true))()

-- --- TAB: Auto Gap Tween ---
local autoGapTab = library:CreateWindow("Auto Gap Tween")
local gapFolder = autoGapTab:AddFolder("Gap Navigation")

local currentGapLabel = gapFolder:AddLabel("Current Gap: Gap #1")

gapFolder:AddSlider({
	text = "Tween Speed",
	min = 50,
	max = 500,
	callback = function(value)
		TweenSpeed = value
	end
})

gapFolder:AddButton({
	text = "Gap Up (Next Gap)",
	callback = function()
		if CurrentGap >= TotalGaps then
			library:Notify({title = "Error", content = "Already at last gap!", duration = 2})
			return
		end
		CurrentGap = CurrentGap + 1
		TweenToGapWithLanding(CurrentGap)
		currentGapLabel.Text = "Current Gap: Gap #" .. tostring(CurrentGap)
	end
})

gapFolder:AddButton({
	text = "Gap Down (Previous Gap)",	callback = function()
		if CurrentGap <= 1 then
			library:Notify({title = "Error", content = "Already at first gap!", duration = 2})
			return
		end
		CurrentGap = CurrentGap - 1
		TweenToGapWithLanding(CurrentGap)
		currentGapLabel.Text = "Current Gap: Gap #" .. tostring(CurrentGap)
	end
})

gapFolder:AddButton({
	text = "Stop Current Tween",
	callback = function()
		StopCurrentTween()
		library:Notify({title = "Stopped", content = "Tween cancelled.", duration = 1.5})
	end
})

gapFolder:AddButton({
	text = "Reset to Gap #1",
	callback = function()
		CurrentGap = 1
		LandingCFrame = nil
		TweenToGapWithLanding(1, function()
			local _, _, hrp = SafeGetCharacter()
			if hrp then LandingCFrame = hrp.CFrame end
		end)
		currentGapLabel.Text = "Current Gap: Gap #1"
		library:Notify({title = "Reset", content = "Teleported to Gap #1", duration = 1.5})
	end
})

gapFolder:AddToggle({
	text = "Auto Gap (Advance when near)",
	callback = function(value)
		AutoGapEnabled = value
		if value then
			library:Notify({title = "Auto Gap", content = "Enabled", duration = 2})
		end
	end
})

-- Thêm nút teleport trực tiếp tới từng gap
for i = 1, TotalGaps do
	gapFolder:AddButton({
		text = "Teleport to Gap #" .. i,
		callback = function()
			CurrentGap = i
			TweenToGapWithLanding(i)			currentGapLabel.Text = "Current Gap: Gap #" .. i
		end
	})
end

-- --- TAB: Loop Attack ---
local loopTab = library:CreateWindow("Loop Attack")
local loopFolder = loopTab:AddFolder("Player Selection")

local playerDropdown = loopFolder:AddList({
	text = "Select Players",
	values = GetPlayerList(),
	multiselect = true,
	callback = function(options)
		SelectedPlayers = options
	end
})

loopFolder:AddButton({
	text = "Refresh Player List",
	callback = function()
		playerDropdown.values = GetPlayerList()
		playerDropdown:Refresh()
	end
})

loopFolder:AddButton({
	text = "Select All Players",
	callback = function()
		SelectedPlayers = GetPlayerList()
		playerDropdown:Refresh()
	end
})

loopFolder:AddButton({
	text = "Clear Selection",
	callback = function()
		SelectedPlayers = {}
		playerDropdown:Refresh()
	end
})

loopFolder:AddSlider({
	text = "Bring Distance (Studs)",
	min = 1,
	max = 20,
	callback = function(value)
		BringDistance = value
	end
})
loopFolder:AddToggle({
	text = "Loop Bring",
	callback = function(value)
		LoopBringEnabled = value
	end
})

loopFolder:AddButton({
	text = "Bring Selected Players Once",
	callback = function()
		BringSelectedPlayers()
	end
})

-- === [ VÒNG LẶP NỀN ] ===
task.spawn(function()
	while task.wait(0.1) do
		if LoopBringEnabled then
			BringSelectedPlayers()
		end
	end
end)

task.spawn(function()
	while task.wait(0.5) do
		if AutoGapEnabled and not TweenRunning then
			local _, _, hrp = SafeGetCharacter()
			if hrp and CurrentGap < TotalGaps then
				local pos = GapPositions[CurrentGap]
				if pos and (hrp.Position - pos).Magnitude < 20 then
					CurrentGap = CurrentGap + 1
					TweenToGapWithLanding(CurrentGap)
					currentGapLabel.Text = "Current Gap: Gap #" .. tostring(CurrentGap)
				end
			end
		end
	end
end)

-- === [ XỬ LÝ THÊM NGƯỜI CHƠI MỚI ] ===
Players.PlayerAdded:Connect(function()
	task.wait(0.5)
	if playerDropdown then
		playerDropdown.values = GetPlayerList()
		playerDropdown:Refresh()
	end
end)

Players.PlayerRemoving:Connect(function(player)	for i, name in ipairs(SelectedPlayers) do
		if name == player.Name then
			table.remove(SelectedPlayers, i)
			break
		end
	end
end)

-- === [ KHỞI ĐỘNG GUI ] ===
library:Init()
